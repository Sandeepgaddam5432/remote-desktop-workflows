name: LINUX DESKTOP - FAST VNC (XFCE + TigerVNC)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Setup Cloudflared
        uses: AnimMouse/setup-cloudflared@v2

      - name: Install XFCE + TigerVNC (lightweight)
        run: |
          sudo apt-get update -y
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 xfce4-goodies tigervnc-standalone-server autocutsel
          echo "‚úÖ XFCE + TigerVNC installed"

      - name: Configure TigerVNC
        run: |
          mkdir -p $HOME/.vnc
          echo "P@ssw0rd123!" | vncpasswd -f > $HOME/.vnc/passwd
          chmod 600 $HOME/.vnc/passwd

          cat > $HOME/.vnc/xstartup <<'EOF'
          #!/bin/sh
          xrdb $HOME/.Xresources
          autocutsel -fork
          startxfce4 &
          EOF
          chmod +x $HOME/.vnc/xstartup
          echo "‚úÖ VNC password and xstartup configured"

      - name: Start VNC Server on :1 (5901)
        run: |
          vncserver -kill :1 >/dev/null 2>&1 || true
          vncserver :1 -geometry 1920x1080 -depth 24 -localhost no
          echo "‚úÖ VNC up on :1 (tcp/5901)"

      - name: Start Cloudflare Tunnel (TCP->5901)
        run: |
          cloudflared tunnel --loglevel warn --url tcp://localhost:5901 > tunnel.log 2>&1 &
          for i in {1..15}; do
            sleep 1
            TUN=$(grep -o 'https://[^[:space:]]*trycloudflare.com' tunnel.log | head -1 || true)
            if [ -n "$TUN" ]; then echo "üåê $TUN"; break; fi
          done
          if [ -z "$TUN" ]; then
            echo "‚ùå Tunnel URL not found"; tail -50 tunnel.log; exit 1
          fi
          echo "‚úÖ Tunnel ready"

      - name: Show Connect Info
        run: |
          TUN=$(grep -o 'https://[^[:space:]]*trycloudflare.com' tunnel.log | head -1)
          echo "-------------------------------------------"
          echo "VNC Address: ${TUN#https://}:5901"
          echo "Password   : P@ssw0rd123!"
          echo "Desktop    : XFCE"
          echo "-------------------------------------------"

      - name: Keep alive ~15 minutes
        run: |
          for i in {1..15}; do
            echo "‚úì Alive $i/15"
            sleep 60
          done
