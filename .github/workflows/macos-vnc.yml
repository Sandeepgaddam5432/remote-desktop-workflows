name: macOS VNC Desktop - Remote Access

on:
  workflow_dispatch:
    inputs:
      password:
        description: 'VNC Password (default: P@ssw0rd123!)'
        required: false
        default: 'P@ssw0rd123!'
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/macos-vnc.yml'

jobs:
  macos-desktop:
    runs-on: macos-latest
    timeout-minutes: 360  # 6 hours max

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Cloudflared
        run: |
          brew install cloudflare/cloudflare/cloudflared
          echo "‚úÖ Cloudflared Installed!"

      - name: Enable VNC/Screen Sharing
        run: |
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate -configure -access -on -restart -agent -privs -all -allowAccessFor -allUsers
          sudo defaults write /var/db/launchd.db/com.apple.launchd/overrides.plist com.apple.screensharing -dict Disabled -bool false
          echo "‚úÖ VNC Enabled!"

      - name: Set VNC Password
        shell: bash
        run: |
          set -e
          PASSWORD="${{ github.event.inputs.password || 'P@ssw0rd123!' }}"
          
          # Ensure RemoteManagement directories exist
          sudo mkdir -p /Library/Preferences
          
          # Use kickstart to set legacy VNC password
          echo "$PASSWORD" | sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -restart -agent -privs -all \
            -clientopts -setvnclegacy -vnclegacy yes -setvncpw -vncpw "$PASSWORD"
          
          # Restart screen sharing service
          sudo launchctl unload /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist
          
          echo "‚úÖ VNC Password Set: $PASSWORD"

      - name: Get System Information
        run: |
          echo "üìä SYSTEM INFORMATION:"
          echo "   macOS Version: $(sw_vers -productVersion)"
          echo "   Architecture: $(uname -m)"
          echo "   Hostname: $(hostname)"
          echo "   IP Address: $(ifconfig | grep 'inet ' | grep -v '127.0.0.1' | head -1 | awk '{print $2}')"

      - name: Start Cloudflare Tunnel
        run: |
          echo "============================================"
          echo "üöÄ macOS VNC - CLOUDFLARE TUNNEL"
          echo "============================================"
          echo ""
          
          # Start tunnel in background
          cloudflared tunnel --url tcp://localhost:5900 > tunnel.log 2>&1 &
          TUNNEL_PID=$!
          
          # Wait for tunnel to establish
          sleep 20
          
          # Extract tunnel URL
          TUNNEL_URL=$(cat tunnel.log | grep -o 'https://[^[:space:]]*trycloudflare.com' | head -1)
          
          if [ -n "$TUNNEL_URL" ]; then
            echo "üåê TUNNEL URL: $TUNNEL_URL"
          else
            echo "‚ùå Failed to get tunnel URL. Check logs:"
            cat tunnel.log
          fi
          
          echo ""
          echo "üìã CONNECTION DETAILS:"
          echo "   PASSWORD: ${{ github.event.inputs.password || 'P@ssw0rd123!' }}"
          echo "   OS: macOS $(sw_vers -productVersion)"
          echo "   Architecture: $(uname -m)"
          echo "============================================"
          echo ""
          echo "üîß VNC CLIENT SETUP:"
          echo "   1. Copy the tunnel URL above"
          echo "   2. Use VNC client (RealVNC, TightVNC, etc.)"
          echo "   3. Connect to: [tunnel-url]:5900"
          echo "   4. Enter password when prompted"
          echo "============================================"

      - name: Keep Session Alive
        run: |
          echo "‚è≥ Session Active - Keeping alive for 6 hours..."
          echo "üí° To stop early, cancel the workflow manually"
          
          COUNTER=0
          while [ $COUNTER -lt 360 ]; do  # 6 hours = 360 minutes
            sleep 60
            COUNTER=$((COUNTER + 1))
            echo "‚úì Active - $(date '+%H:%M:%S') - $(($COUNTER))/360 minutes"
            
            # Show tunnel status every 30 minutes
            if [ $((COUNTER % 30)) -eq 0 ]; then
              echo "üîÑ Checking tunnel status..."
              if pgrep -f cloudflared > /dev/null; then
                echo "‚úÖ Tunnel is running"
              else
                echo "‚ùå Tunnel stopped, restarting..."
                cloudflared tunnel --url tcp://localhost:5900 > tunnel.log 2>&1 &
                sleep 10
                cat tunnel.log | grep -o 'https://[^[:space:]]*trycloudflare.com' | head -1
              fi
            fi
          done
          
          echo "‚è∞ Session completed - 6 hours elapsed"